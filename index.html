<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Monitor Master 2026 V135 Ultimate Fix 5.14</title>
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { 
            --blue: #2563eb; 
            --orange: #f97316; 
            --red: #dc2626;    
            --purple: #a855f7; 
            --emerald: #10b981;
            --bg: #f1f5f9; 
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", sans-serif; 
            background: var(--bg); padding-bottom: 120px; color: #0f172a; 
            line-height: 1.3;
            -webkit-text-size-adjust: 100%;
        }

        .clock-font { font-family: 'Courier New', Courier, monospace; font-weight: 900; font-style: italic; }
        .serif-font { font-family: "Yu Mincho", "MS Mincho", serif; }

        .status-bar { 
            position: sticky; top: 0; z-index: 1000; 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); 
            border-bottom: 1px solid #e2e8f0; 
            transition: all 0.3s;
        }
        
        .status-bar.alert-pulse { background: var(--red); color: white !important; }

        .card { 
            background: white; border-radius: 18px; padding: 12px; 
            border: 2px solid #e2e8f0; margin-bottom: 8px; 
            position: relative; overflow: hidden;
        }
        .card.caution { border-color: #fbbf24; background: #fffbeb; }
        .card.urgent { border-color: var(--red); background: #fff1f2; }
        .card.finished { border-color: #d8b4fe; background: #faf5ff; }

        .badge-main {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 1px 6px; border-radius: 4px; font-size: 9px; font-weight: 900; 
            color: white; height: 18px; line-height: 1; letter-spacing: 0.2px;
        }
        .badge-orange { background: var(--orange); }
        .badge-emerald { background: var(--emerald); }
        
        .badge-red-top {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            background: var(--red); color: white; padding: 3px 30px;
            border-bottom-left-radius: 14px; border-bottom-right-radius: 14px;
            font-size: 13px; font-weight: 900; z-index: 10; 
            box-shadow: 0 3px 6px rgba(220, 38, 36, 0.3);
            letter-spacing: 2px;
        }

        .time-stack { display: flex; flex-direction: column; align-items: flex-end; gap: 3px; flex-shrink: 0; }
        .time-box { padding: 4px 8px; border-radius: 10px; border: 1.5px solid #e2e8f0; background: #f8fafc; min-width: 90px; text-align: right; }
        .predicted-box { background: #fff1f2; border-color: #fb7185; }

        .btn-hide {
            position: absolute; top: 0; left: 0;
            width: 32px; height: 32px;
            background: #f1f5f9; color: #94a3b8;
            border: none; border-bottom-right-radius: 10px;
            font-size: 14px; font-weight: 900;
            cursor: pointer; z-index: 50;
            display: flex; align-items: center; justify-content: center;
        }

        .gauge-container { margin: 10px 0; position: relative; }
        .gauge-bar { height: 8px; background: #e2e8f0; border-radius: 8px; overflow: hidden; position: relative; }
        .gauge-fill { height: 100%; transition: width 0.3s linear; position: absolute; top: 0; }
        .gauge-markers { display: flex; justify-content: space-between; padding: 0; margin-top: 2px; }
        .marker { font-size: 8px; font-weight: 900; color: #cbd5e1; width: 24px; text-align: center; }
        .marker.active { color: var(--active-color); opacity: 1; }

        .expand-wrapper { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.3s ease-out; overflow: hidden; }
        .expand-wrapper.open { grid-template-rows: 1fr; padding-top: 8px; }

        .scroll-nav {
            position: fixed; right: 12px; bottom: 85px;
            display: flex; flex-direction: column; gap: 10px;
            z-index: 1500;
        }
        .scroll-btn {
            width: 44px; height: 44px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(4px);
            border: 1px solid #cbd5e1;
            color: #64748b;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal { position: fixed; inset: 0; z-index: 2000; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
    </style>
</head>
<body>

    <div id="top-status" class="status-bar px-4 py-2 flex justify-between items-center text-[10px] font-black">
        <div class="flex items-center gap-2 overflow-hidden whitespace-nowrap">
            <span id="sync-icon" class="text-amber-500 flex-shrink-0">‚óè</span> 
            <span id="sync-label" class="truncate uppercase">CONNECTING...</span>
        </div>
        <div class="flex items-center gap-2 text-[8px] flex-shrink-0">
            <span id="last-sync-time" class="opacity-30 uppercase">READY</span>
            <span id="jst-date-label" class="bg-slate-700 text-white px-2 py-0.5 rounded font-mono">----</span>
        </div>
    </div>

    <!-- „Çπ„ÇØ„É≠„Éº„É´„Éä„Éì -->
    <div class="scroll-nav">
        <button class="scroll-btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>
        </button>
        <button class="scroll-btn" onclick="window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'})">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
        </button>
    </div>

    <div class="container mx-auto max-w-2xl px-3 pt-3">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <div class="bg-white rounded-[24px] p-4 shadow-sm mb-3 border-2 border-white relative">
            <div class="flex justify-between items-start mb-3">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 text-white p-2 rounded-xl shadow-md">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                    </div>
                    <div>
                        <div id="ui-date" class="font-black text-sm">----/--/--</div>
                        <div class="text-[8px] opacity-30 uppercase font-black tracking-widest leading-tight flex flex-col">
                            <span>V135 Ultimate Fix 5.14</span>
                            <span class="text-blue-600 font-bold opacity-100 mt-0.5">‚Äª„Éñ„É©„Ç¶„Ç∂Âà©Áî®Êé®Â•®(Chrome/Safari)</span>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <div id="clock" class="clock-font text-3xl tracking-tighter text-slate-800 leading-none">00:00:00</div>
                    <button onclick="openAdmin()" class="mt-2 text-[9px] font-black text-slate-400 border border-slate-200 px-2 py-0.5 rounded-lg active:bg-slate-100 transition-colors uppercase">Admin Access</button>
                </div>
            </div>
            
            <div class="flex gap-2 mt-2">
                <button id="voice-toggle" onclick="handleVoiceToggle()" class="flex-[3] py-3 rounded-2xl bg-blue-600 text-white font-black text-xs shadow-[0_4px_0_#1e40af] active:translate-y-1 transition-all">
                    üîà Èü≥Â£∞ÈÄöÁü•„ÇíÊúâÂäπ„Å´„Åô„Çã
                </button>
                <button id="test-voice-btn" onclick="handleVoiceTest()" class="flex-1 bg-slate-100 border border-slate-300 rounded-2xl font-black text-[10px] text-slate-500 hidden">
                    üì¢ Ë©¶ËÅ¥
                </button>
            </div>
        </div>

        <div id="list-container" class="space-y-2"></div>

        <div class="mt-8 text-center pb-24">
            <button onclick="toggleHistoryUI()" class="text-slate-400 text-[10px] font-bold underline decoration-2 cursor-pointer">Â±•Ê≠¥„ÇíË°®Á§∫ / ÈùûË°®Á§∫</button>
            <div id="history-list" class="hidden mt-4 space-y-2"></div>
        </div>
    </div>

    <!-- PINË™çË®º„É¢„Éº„ÉÄ„É´ -->
    <div id="modal-pass" class="modal">
        <div class="bg-white p-6 rounded-[32px] w-full max-w-xs text-center shadow-2xl">
            <h3 class="font-black mb-4 uppercase text-xs tracking-widest text-slate-400">Security Check</h3>
            <input type="password" id="pin" class="w-full text-center text-3xl tracking-[10px] p-3 bg-slate-50 border-2 border-slate-200 rounded-2xl mb-6 outline-none focus:border-blue-400" maxlength="4" inputmode="numeric">
            <div class="flex gap-3">
                <button onclick="closeModals()" class="flex-1 font-bold text-slate-400 text-sm">Êàª„Çã</button>
                <button onclick="verifyPin()" class="flex-[1.5] bg-blue-600 text-white p-3 rounded-2xl font-bold">Ë™çË®º</button>
            </div>
        </div>
    </div>

    <!-- „Éá„Éº„ÇøÂêåÊúü„É¢„Éº„ÉÄ„É´ -->
    <div id="modal-admin" class="modal" onclick="if(event.target==this)closeModals()">
        <div class="bg-white p-6 rounded-[32px] w-full max-w-xl shadow-2xl" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-1">
                <h3 class="font-black text-lg">JSON Cloud Sync</h3>
                <span class="text-[10px] font-black text-emerald-500 uppercase">Input Persisted</span>
            </div>
            <p id="import-status" class="hidden mb-2 p-3 rounded-xl font-bold text-xs"></p>
            <textarea id="json-input" class="w-full font-mono text-[10px] border-2 border-slate-100 rounded-2xl p-3 mb-4 h-80 outline-none focus:border-blue-300" placeholder="[...]"></textarea>
            <div class="flex gap-3">
                <button onclick="closeModals()" class="flex-1 font-bold text-slate-400">Èñâ„Åò„Çã</button>
                <button id="import-btn" onclick="doImport()" class="flex-[2] bg-blue-600 text-white p-4 rounded-2xl font-black shadow-lg disabled:opacity-50">ÂêåÊúü„ÇíÂÆüË°å</button>
            </div>
        </div>
    </div>

    <audio id="chime-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <script>
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const PIN = "2026";

        let db, auth;
        let state = {
            evs: [],
            hidden: new Set(),
            ex: new Set(),
            audio: false,
            notified: new Set(),
            showHistory: false,
            user: null
        };

        function getJST() {
            const d = new Date();
            const j = new Date(d.getTime() + (d.getTimezoneOffset() * 60000) + (9 * 3600000));
            const y = j.getFullYear(), m = String(j.getMonth()+1).padStart(2,'0'), dd = String(j.getDate()).padStart(2,'0');
            return { stamp: `${y}${m}${dd}`, display: `${y}/${m}/${dd}`, time: j.toLocaleTimeString('ja-JP', {hour12:false}) };
        }

        async function init() {
            if (!firebaseConfig) return;
            try {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                auth.onAuthStateChanged(user => {
                    const syncIcon = document.getElementById('sync-icon');
                    const syncLabel = document.getElementById('sync-label');
                    if (user) {
                        state.user = user;
                        syncIcon.className = 'text-emerald-500';
                        syncLabel.innerHTML = `ONLINE <span class="font-normal opacity-50 ml-1 text-[8px]">ID:${user.uid}</span>`;
                        startListening();
                    } else {
                        syncIcon.className = 'text-amber-500';
                        syncLabel.innerText = 'CONNECTING...';
                        ensureAuth();
                    }
                });
            } catch (e) { console.error("Init Error:", e); }
        }

        async function ensureAuth() {
            try {
                if (initialAuthToken) { await auth.signInWithCustomToken(initialAuthToken); }
                else { await auth.signInAnonymously(); }
            } catch (e) { console.error("Auth Error:", e); }
        }

        function startListening() {
            const path = `artifacts/${appId}/public/data/events`;
            db.collection(path).onSnapshot(snap => {
                state.evs = snap.docs.map(doc => ({id: String(doc.id), ...doc.data()}));
                document.getElementById('last-sync-time').innerText = `UPDATE: ${getJST().time}`;
                render();
            }, err => { console.error("Listen Error:", err); });
        }

        function triggerAttentionCombined(messages) {
            if(!state.audio || messages.length === 0) return;
            const chime = document.getElementById('chime-sound');
            const bar = document.getElementById('top-status');
            const fullText = messages.join(' ');
            bar.classList.add('alert-pulse');
            setTimeout(() => bar.classList.remove('alert-pulse'), 5000);
            chime.volume = 1.0;
            chime.currentTime = 0;
            chime.play().then(() => {
                setTimeout(() => speak(fullText), 850);
            }).catch(() => speak(fullText));
        }

        function speak(text) {
            window.speechSynthesis.cancel(); 
            const ut = new SpeechSynthesisUtterance(text);
            ut.lang = 'ja-JP'; ut.rate = 1.05; ut.pitch = 1.1; ut.volume = 1.0;
            window.speechSynthesis.speak(ut);
        }

        function handleVoiceToggle() {
            state.audio = !state.audio;
            const btn = document.getElementById('voice-toggle');
            const testBtn = document.getElementById('test-voice-btn');
            if(state.audio) {
                btn.className = "flex-[3] py-3 rounded-2xl bg-purple-500 text-white font-black text-xs shadow-[0_4px_0_#7e22ce] active:translate-y-1 transition-all";
                btn.innerHTML = "üîä Èü≥Â£∞ÈÄöÁü•: ON";
                testBtn.classList.remove('hidden');
                triggerAttentionCombined(["Èü≥Â£∞ÈÄöÁü•„ÇíÊúâÂäπ„Å´„Åó„Åæ„Åó„Åü„ÄÇ20ÂàÜÂâç„Å®10ÂàÜÂâç„Å´ÈÄöÁü•„Åó„Åæ„Åô„ÄÇ"]);
            } else {
                btn.className = "flex-[3] py-3 rounded-2xl bg-blue-600 text-white font-black text-xs shadow-[0_4px_0_#1e40af] active:translate-y-1 transition-all";
                btn.innerHTML = "üîà Èü≥Â£∞ÈÄöÁü•„ÇíÊúâÂäπ„Å´„Åô„Çã";
                testBtn.classList.add('hidden');
            }
        }

        function handleVoiceTest() { triggerAttentionCombined(["„ÉÜ„Çπ„Éà„Ç¢„Éä„Ç¶„É≥„Çπ„ÄÇ„Åæ„Å®„ÇÅÈÄöÁü•Ê©üËÉΩ„ÅÆÂãï‰Ωú„ÇíÁ¢∫Ë™ç‰∏≠„ÄÇ"]); }

        function render() {
            const jst = getJST();
            const now = new Date();
            document.getElementById('ui-date').innerText = jst.display;
            document.getElementById('jst-date-label').innerText = jst.stamp;
            const listEl = document.getElementById('list-container');
            const histEl = document.getElementById('history-list');
            
            const data = state.evs.filter(e => e.date === jst.stamp).map(e => {
                const [h, m] = e.end.split(':').map(Number);
                const t = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0);
                return { ...e, diffMin: Math.floor((t - now) / 60000) };
            });

            const main = data.filter(e => !state.hidden.has(String(e.id)) && e.diffMin > -60).sort((a,b)=>a.diffMin-b.diffMin);
            const history = data.filter(e => state.hidden.has(String(e.id)) || e.diffMin <= -60).sort((a,b)=>b.diffMin-a.diffMin);
            
            listEl.innerHTML = main.length ? main.map(e => createCard(e)).join('') : `<div class="p-16 text-center opacity-20 font-black">NO ACTIVE EVENTS</div>`;
            histEl.innerHTML = history.map(e => createCard(e, true)).join('');

            if (state.audio) {
                const alertTimes = [20, 10];
                const activeGroups = [];
                alertTimes.forEach(time => {
                    const venuesAtThisTime = main.filter(e => e.diffMin === time).map(e => String(e.location).split('@')[0]);
                    if (venuesAtThisTime.length > 0) {
                        const uniqueVenues = [...new Set(venuesAtThisTime)].join('„ÄÅ');
                        const key = `notify_${time}_${uniqueVenues}`;
                        if (!state.notified.has(key)) {
                            activeGroups.push(`${uniqueVenues}„ÄÅ${time}ÂàÜÂâç„Åß„Åô„ÄÇ`);
                            state.notified.add(key);
                        }
                    }
                });
                if (activeGroups.length > 0) triggerAttentionCombined(activeGroups);
            }
        }

        function createCard(e, isHist = false) {
            const isF = e.diffMin <= 0, isC = e.cancelled === true;
            const urgent = e.diffMin <= 10 && !isF, caution = e.diffMin <= 30 && !urgent && !isF;
            const cardClass = isC ? 'cancelled' : isF ? 'finished' : urgent ? 'urgent' : caution ? 'caution' : '';
            const activeColor = isF ? 'var(--purple)' : urgent ? 'var(--red)' : caution ? 'var(--orange)' : 'var(--blue)';
            
            let progress = 0, gaugeStyle = "";
            if (!isF) {
                const ratio = Math.max(0, Math.min(60, 60 - e.diffMin)) / 60;
                progress = ratio * 100;
                gaugeStyle = `width: ${progress}%; background: ${activeColor}; left: 0;`;
            } else {
                const ratio = Math.max(0, Math.min(60, 60 - Math.abs(e.diffMin))) / 60;
                progress = ratio * 100;
                gaugeStyle = `width: ${progress}%; background: ${activeColor}; right: 0;`;
            }
            
            const isLarge = (parseInt(String(e.capa).replace(/,/g, '')) || 0) >= 8000;
            const isSoldOut = (e.name && e.name.includes("ÂÆåÂ£≤")) || e.soldOut;

            return `
                <div class="card ${cardClass} shadow-md border-slate-200">
                    ${isF ? `<div class="badge-red-top">ÁµÇ ‰∫Ü</div>` : ''}
                    <button class="btn-hide shadow-sm" onclick="event.stopPropagation(); toggleHide('${e.id}')"> ${isHist ? '‚Ü∫' : '‚úï'} </button>
                    <div class="flex justify-between items-start mb-1 mt-4">
                        <div class="flex-1 pr-3">
                            <div class="mb-1">
                                <span class="text-blue-600 font-black text-base underline decoration-1 underline-offset-4 cursor-pointer leading-tight" 
                                      onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(String(e.location).split('@')[0])}')">
                                    üìç ${String(e.location).split('@')[0]}
                               
